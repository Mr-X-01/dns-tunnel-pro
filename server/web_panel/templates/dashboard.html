{% extends "base.html" %}

{% block title %}Dashboard - DNS Tunnel Pro{% endblock %}

{% block content %}
<h2 style="color: white; margin-bottom: 2rem;">üìä Dashboard</h2>

<div class="stats-grid">
    <div class="stat-card">
        <h3>–í—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤</h3>
        <div class="value">{{ total_clients }}</div>
    </div>
    
    <div class="stat-card">
        <h3>–ê–∫—Ç–∏–≤–Ω—ã—Ö</h3>
        <div class="value" style="color: #2ecc71;">{{ active_clients }}</div>
    </div>
    
    <div class="stat-card">
        <h3>–¢—Ä–∞—Ñ–∏–∫</h3>
        <div class="value" style="font-size: 1.8rem;">
            {% if total_traffic > 1073741824 %}
                {{ "%.2f"|format(total_traffic / 1073741824) }} GB
            {% elif total_traffic > 1048576 %}
                {{ "%.2f"|format(total_traffic / 1048576) }} MB
            {% elif total_traffic > 1024 %}
                {{ "%.2f"|format(total_traffic / 1024) }} KB
            {% else %}
                {{ total_traffic }} B
            {% endif %}
        </div>
    </div>
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—ã</h3>
        <a href="{{ url_for('add_client') }}" class="btn">+ –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</a>
    </div>
    
    {% if clients %}
    <table>
        <thead>
            <tr>
                <th>–ò–º—è</th>
                <th>Client ID</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                <th>–¢—Ä–∞—Ñ–∏–∫</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for client in clients[:10] %}
            <tr>
                <td><strong>{{ client.name }}</strong></td>
                <td><code style="font-size: 0.85rem;">{{ client.client_id[:16] }}...</code></td>
                <td>
                    {% if client.last_seen and (now - client.last_seen).seconds < 300 %}
                        <span class="badge badge-success">‚óè –û–Ω–ª–∞–π–Ω</span>
                    {% elif client.last_seen %}
                        <span class="badge badge-warning">‚óã –û—Ñ—Ñ–ª–∞–π–Ω</span>
                    {% else %}
                        <span class="badge badge-danger">‚úï –ù–µ –ø–æ–¥–∫–ª—é—á–∞–ª—Å—è</span>
                    {% endif %}
                </td>
                <td>
                    {% if client.last_seen %}
                        {{ client.last_seen.strftime('%Y-%m-%d %H:%M') }}
                    {% else %}
                        –ù–∏–∫–æ–≥–¥–∞
                    {% endif %}
                </td>
                <td>
                    {% set total = client.bytes_sent + client.bytes_received %}
                    {% if total > 1048576 %}
                        {{ "%.1f"|format(total / 1048576) }} MB
                    {% elif total > 1024 %}
                        {{ "%.1f"|format(total / 1024) }} KB
                    {% else %}
                        {{ total }} B
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('client_detail', client_id=client.id) }}" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="text-align: center; padding: 3rem; color: #95a5a6;">
        <p style="font-size: 1.2rem;">–ü–æ–∫–∞ –Ω–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤</p>
        <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</p>
        <a href="{{ url_for('add_client') }}" class="btn" style="margin-top: 1rem;">+ –°–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</a>
    </div>
    {% endif %}
</div>

{% if clients %}
<div class="card">
    <h3 style="margin-bottom: 1rem;">–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç</h3>
    <div class="code-block">
# –ù–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ (Linux):<br>
curl -sSL https://YOUR_SERVER_IP:8443/install-client.sh | bash<br>
dns-tunnel-client connect config.json
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Auto-refresh stats every 30 seconds
    setInterval(function() {
        fetch('{{ url_for("api_stats") }}')
            .then(response => response.json())
            .then(data => {
                console.log('Stats updated:', data);
                // Update stats on page without reload if needed
            })
            .catch(error => console.error('Error fetching stats:', error));
    }, 30000);
</script>
{% endblock %}
